name: CI/CD Pipeline

on:
  # Run tests on all PRs to main
  pull_request:
    branches: [ main ]
  
  # Auto-deploy to dev when merged to main
  push:
    branches: [ main ]
  
  # Manual deployment to production
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod

jobs:
  # Stage 1: Run tests, lint, and type checking on all PRs and main branch pushes
  test-and-quality:
    runs-on: ubuntu-latest
    name: "ğŸ§ª Tests, Lint & Type Check"
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Run tests
      run: |
        python -m pytest tests/ -v --cov=. --cov-report=xml
        
    - name: Run Lint
      run: ruff check .
      
    - name: Run Type Check
      run: |
        # Run mypy directly on main.py and tests directory
        python -m mypy main.py tests/

  # Stage 2: Always show deployment stage (but conditionally execute)
  check-deployment-trigger:
    needs: test-and-quality
    runs-on: ubuntu-latest
    name: "ğŸ” Check Deployment Trigger"
    steps:
    - name: Analyze deployment conditions
      run: |
        echo "Event: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "Branch: ${{ github.ref_name }}"
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "âœ… Will deploy to development (auto-deploy on main)"
        elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "âœ… Will deploy to ${{ github.event.inputs.environment }} (manual trigger)"
        else
          echo "â„¹ï¸ No deployment triggered for this event"
        fi

  # Stage 3: Deploy to Development (auto on main push, manual trigger available)
  deploy-dev:
    needs: [test-and-quality, check-deployment-trigger]
    runs-on: ubuntu-latest
    name: "ğŸš€ Deploy to Development"
    if: always()
    environment: 
      name: development
      url: https://be-de.ornakala.com
    
    steps:
    - name: Check deployment conditions
      run: |
        echo "ğŸ” Deployment Debug Info:"
        echo "Event Name: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Environment Input: ${{ github.event.inputs.environment }}"
        echo "Test Quality Result: ${{ needs.test-and-quality.result }}"
        
        # Check if tests passed first
        if [[ "${{ needs.test-and-quality.result }}" != "success" ]]; then
          echo "âŒ Tests failed - skipping deployment"
          echo "SHOULD_DEPLOY=false" >> $GITHUB_ENV
          exit 0
        fi
        
        # Check if we should actually deploy
        SHOULD_DEPLOY=false
        
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "âœ… Deploying due to: Push to main branch"
          SHOULD_DEPLOY=true
        elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.environment }}" == "dev" ]]; then
          echo "âœ… Deploying due to: Manual trigger for dev environment"
          SHOULD_DEPLOY=true
        else
          echo "â„¹ï¸ Deployment conditions not met - stage will be skipped"
          echo "  Event: ${{ github.event_name }}"
          echo "  Branch: ${{ github.ref }}"
          echo "  Environment: ${{ github.event.inputs.environment }}"
        fi
        
        # Set output for next steps
        echo "SHOULD_DEPLOY=$SHOULD_DEPLOY" >> $GITHUB_ENV

    - name: Debug deployment conditions
      if: env.SHOULD_DEPLOY == 'false'
      run: |
        echo "â­ï¸ Skipping deployment - conditions not met"
        echo "This stage shows up but deployment is skipped based on trigger conditions"
        exit 0

    - uses: actions/checkout@v4
      if: env.SHOULD_DEPLOY == 'true'

    - name: Configure AWS credentials
      if: env.SHOULD_DEPLOY == 'true'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
      continue-on-error: true  # Don't fail if AWS credentials are not configured

    - name: Deploy to Development Server
      if: env.SHOULD_DEPLOY == 'true'
      run: |
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > private_key.pem
        chmod 600 private_key.pem
        
        # Debug connection details
        echo "ğŸ” Connection Debug Info:"
        echo "Target Host: ${{ secrets.EC2_DEV_HOST }}"
        echo "Target User: ${{ secrets.EC2_DEV_USER }}"
        echo "GitHub Runner IP: $(curl -s https://api.ipify.org)"
        
        # Test if host is reachable
        echo "ğŸ“ Testing host reachability..."
        ping -c 3 ${{ secrets.EC2_DEV_HOST }} || echo "Ping failed, but deployment might still work"
        
        # Try AWS SSM approach first (if AWS credentials are available)
        if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
          echo "ğŸ”§ Attempting deployment via AWS Systems Manager..."
          
          # Configure AWS CLI
          aws configure set aws_access_key_id "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws configure set default.region "${{ secrets.AWS_REGION }}"
          
          # Create deployment script for SSM
          cat > ssm-deploy.sh << 'EOFSSM'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ Starting SSM deployment to development server..."
        
        # Navigate to application directory
        cd /home/ubuntu/ornakala-backend || {
          echo "Creating ornakala-backend directory..."
          mkdir -p /home/ubuntu/ornakala-backend
          cd /home/ubuntu/ornakala-backend
        }
        
        # Stop existing main.py process if running
        echo "ğŸ›‘ Stopping existing main.py process..."
        pkill -f "python.*main.py" || echo "No existing main.py process found"
        sleep 2
        
        # Pull latest code (using public access)
        echo "ğŸ“¥ Pulling latest code..."
        if [ -d ".git" ]; then
          git fetch origin
          git reset --hard origin/main
        else
          git clone https://github.com/Ornakala-T1/ornakala-backend.git .
        fi
        
        # Install/update dependencies
        echo "ğŸ“¦ Installing dependencies..."
        python3 -m pip install --user -r requirements.txt
        
        # Start main.py in background
        echo "â–¶ï¸ Starting main.py..."
        nohup python3 main.py > app.log 2>&1 &
        
        # Wait and verify
        sleep 3
        if pgrep -f "python.*main.py" > /dev/null; then
          echo "âœ… main.py started successfully!"
          echo "ğŸ“‹ Process ID: \$(pgrep -f 'python.*main.py')"
        else
          echo "âŒ Failed to start main.py. Check app.log for errors."
          tail -20 app.log || echo "No log file found"
          exit 1
        fi
        
        echo "ğŸ‰ SSM deployment completed successfully!"
        EOFSSM

          # Get instance ID from dev host IP
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=ip-address,Values=${{ secrets.EC2_DEV_HOST }}" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' --output text)
          
          if [ "$INSTANCE_ID" = "null" ] || [ -z "$INSTANCE_ID" ]; then
            echo "âŒ Could not find instance ID for ${{ secrets.EC2_DEV_HOST }}"
            echo "ğŸ”„ Falling back to SSH method..."
          else
            echo "ğŸ“‹ Found instance ID: $INSTANCE_ID"
            
            # Execute deployment via SSM
            COMMAND_ID=$(aws ssm send-command \
              --instance-ids "$INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --parameters 'commands=["'"$(cat ssm-deploy.sh | tr '\n' ';')"'"]' \
              --query 'Command.CommandId' --output text)
            
            echo "ğŸ“‹ SSM Command ID: $COMMAND_ID"
            
            # Wait for command to complete
            echo "â³ Waiting for deployment to complete..."
            sleep 30
            
            # Get command output
            aws ssm get-command-invocation \
              --instance-id "$INSTANCE_ID" \
              --command-id "$COMMAND_ID" \
              --query 'StandardOutputContent' --output text
            
            echo "âœ… SSM deployment completed!"
            exit 0
          fi
        fi
        
        # Fallback to SSH method with retries
        echo "ğŸ”„ Attempting SSH deployment..."
        
        # Function to test SSH with retries
        test_ssh_connection() {
          local max_attempts=3
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ” SSH attempt $attempt/$max_attempts..."
            if ssh -i private_key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=10 \
               ${{ secrets.EC2_DEV_USER }}@${{ secrets.EC2_DEV_HOST }} \
               'echo "SSH connection successful"' 2>/dev/null; then
              echo "âœ… SSH connection established on attempt $attempt"
              return 0
            fi
            echo "âŒ SSH attempt $attempt failed"
            if [ $attempt -lt $max_attempts ]; then
              echo "â³ Waiting 10 seconds before retry..."
              sleep 10
            fi
            ((attempt++))
          done
          
          return 1
        }
        
        # Test SSH connection with fewer retries (since we have SSM fallback)
        if ! test_ssh_connection; then
          echo "ğŸ’¥ All deployment methods failed!"
          echo ""
          echo "âš ï¸ Both SSM and SSH deployment failed. This might be due to:"
          echo "  1. GitHub Actions IP ranges blocked in AWS Network ACLs"
          echo "  2. EC2 instance doesn't have SSM agent configured"
          echo "  3. AWS credentials not properly configured"
          echo ""
          echo "ğŸ“§ Manual deployment required. Please run:"
          echo "  ssh -i ornakala-keypair-fixed.pem ubuntu@${{ secrets.EC2_DEV_HOST }}"
          echo "  cd ~/ornakala-backend && git pull && python3 main.py"
          echo ""
          echo "ğŸ”§ To fix automatic deployment:"
          echo "  1. Install SSM agent on EC2 instances, OR"
          echo "  2. Use self-hosted GitHub Actions runner, OR"
          echo "  3. Check AWS Network ACLs and VPC routing"
          exit 1
        fi
        
        # Create deployment script inline
        cat > deploy-dev.sh << 'EOFDEV'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ Starting deployment to development server..."
        
        # Navigate to application directory
        cd ~/ornakala-backend || {
          echo "Creating ornakala-backend directory..."
          mkdir -p ~/ornakala-backend
          cd ~/ornakala-backend
        }
        
        # Stop existing main.py process if running
        echo "ğŸ›‘ Stopping existing main.py process..."
        pkill -f "python.*main.py" || echo "No existing main.py process found"
        sleep 2
        
        # Pull latest code
        echo "ğŸ“¥ Pulling latest code..."
        if [ -d ".git" ]; then
          git fetch origin
          git reset --hard origin/main
        else
          git clone https://github.com/Ornakala-T1/ornakala-backend.git .
        fi
        
        # Install/update dependencies
        echo "ğŸ“¦ Installing dependencies..."
        python3 -m pip install --user -r requirements.txt
        
        # Start main.py in background
        echo "â–¶ï¸ Starting main.py..."
        nohup python3 main.py > app.log 2>&1 &
        
        # Wait a bit and check if process started successfully
        sleep 3
        if pgrep -f "python.*main.py" > /dev/null; then
          echo "âœ… main.py started successfully!"
          echo "ğŸ“‹ Process ID: \$(pgrep -f 'python.*main.py')"
        else
          echo "âŒ Failed to start main.py. Check app.log for errors."
          tail -20 app.log
          exit 1
        fi
        
        echo "ğŸ‰ Deployment completed successfully!"
        EOFDEV
        
        # Copy deployment script with timeout
        echo "ğŸ“¤ Copying deployment script..."
        scp -i private_key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
          deploy-dev.sh \
          ${{ secrets.EC2_DEV_USER }}@${{ secrets.EC2_DEV_HOST }}:/home/${{ secrets.EC2_DEV_USER }}/
        
        # Execute deployment with timeout
        echo "ğŸš€ Executing deployment..."
        ssh -i private_key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=10 \
          ${{ secrets.EC2_DEV_USER }}@${{ secrets.EC2_DEV_HOST }} \
          'chmod +x deploy-dev.sh && timeout 300 ./deploy-dev.sh'

    - name: Verify Deployment
      if: env.SHOULD_DEPLOY == 'true'
      run: |
        # Wait a bit for the service to fully start
        sleep 5
        
        # Check if the service is responding (assuming it runs on port 8000)
        echo "ğŸ” Checking if main.py is running..."
        ssh -i private_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_DEV_USER }}@${{ secrets.EC2_DEV_HOST }} \
          'pgrep -f "python.*main.py" && echo "âœ… main.py is running" || echo "âŒ main.py is not running"'

    - name: Notify Development Deployment
      if: env.SHOULD_DEPLOY == 'true'
      run: |
        echo "âœ… Development deployment completed!"
        echo "ğŸ”— Test your changes at: https://be-de.ornakala.com"
        echo "ğŸ“ Once testing is complete, you can manually deploy to production"
        echo "ğŸ“‹ main.py is running directly on the server in ~/ornakala-backend/"

    - name: Manual Deployment Instructions (on failure)
      if: failure()
      run: |
        echo "ğŸš¨ Automated deployment failed!"
        echo ""
        echo "ğŸ“‹ Manual deployment steps:"
        echo "1. SSH to server: ssh -i \"ornakala-keypair-fixed.pem\" ubuntu@ec2-3-143-178-63.us-east-2.compute.amazonaws.com"
        echo "2. Navigate to app: cd ~/ornakala-backend"
        echo "3. Pull latest code: git pull origin main"
        echo "4. Stop existing process: pkill -f 'python.*main.py'"
        echo "5. Install dependencies: python3 -m pip install --user -r requirements.txt"
        echo "6. Start application: nohup python3 main.py > app.log 2>&1 &"
        echo "7. Verify: pgrep -f 'python.*main.py'"
        echo ""
        echo "ğŸ”§ To fix automation, check AWS EC2 security group allows SSH from 0.0.0.0/0"

  # Stage 4: Deploy to Production (manual trigger only)
  deploy-prod:
    needs: [test-and-quality, check-deployment-trigger]
    runs-on: ubuntu-latest
    name: "ğŸ¯ Deploy to Production"
    if: always()
    environment: 
      name: production
      url: https://be-pr.ornakala.com
    
    steps:
    - name: Check production deployment conditions
      run: |
        echo "ğŸ” Production Deployment Debug Info:"
        echo "Event Name: ${{ github.event_name }}"
        echo "Environment Input: ${{ github.event.inputs.environment }}"
        echo "Test Quality Result: ${{ needs.test-and-quality.result }}"
        
        # Check if tests passed first
        if [[ "${{ needs.test-and-quality.result }}" != "success" ]]; then
          echo "âŒ Tests failed - skipping production deployment"
          echo "SHOULD_DEPLOY=false" >> $GITHUB_ENV
          exit 0
        fi
        
        # Check if we should actually deploy to production
        SHOULD_DEPLOY=false
        
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.environment }}" == "prod" ]]; then
          echo "âœ… Deploying to production due to: Manual trigger for prod environment"
          SHOULD_DEPLOY=true
        else
          echo "â„¹ï¸ Production deployment conditions not met - stage will be skipped"
          echo "  Production requires manual trigger with environment=prod"
          echo "  Current event: ${{ github.event_name }}"
          echo "  Current environment: ${{ github.event.inputs.environment }}"
        fi
        
        # Set output for next steps
        echo "SHOULD_DEPLOY=$SHOULD_DEPLOY" >> $GITHUB_ENV

    - name: Debug production conditions
      if: env.SHOULD_DEPLOY == 'false'
      run: |
        echo "â­ï¸ Skipping production deployment - manual trigger required"
        echo "This stage shows up but deployment is skipped (production requires manual trigger)"
        exit 0

    - uses: actions/checkout@v4
      if: env.SHOULD_DEPLOY == 'true'

    - name: Check if commit was deployed to dev
      if: env.SHOULD_DEPLOY == 'true'
      run: |
        echo "âš ï¸  IMPORTANT: Ensure this commit (${{ github.sha }}) has been tested on development!"
        echo "ğŸ”— Development URL: https://be-de.ornakala.com"
        echo "ğŸ¯ Production deployment will use commit: ${{ github.sha }}"

    - name: Deploy to Production Server
      if: env.SHOULD_DEPLOY == 'true'
      run: |
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > private_key.pem
        chmod 600 private_key.pem
        
        # Create production deployment script
        cat > deploy-prod.sh << 'EOFPROD'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ Starting production deployment..."
        
        # Navigate to application directory
        cd ~/ornakala-backend || {
          echo "Creating ornakala-backend directory..."
          mkdir -p ~/ornakala-backend
          cd ~/ornakala-backend
        }
        
        # Stop existing main.py process if running
        echo "ğŸ›‘ Stopping existing main.py process..."
        pkill -f "python.*main.py" || echo "No existing main.py process found"
        sleep 3
        
        # Pull latest code
        echo "ğŸ“¥ Pulling latest code..."
        if [ -d ".git" ]; then
          git fetch origin
          git reset --hard origin/main
        else
          git clone https://github.com/Ornakala-T1/ornakala-backend.git .
        fi
        
        # Install/update dependencies
        echo "ğŸ“¦ Installing dependencies..."
        python3 -m pip install --user -r requirements.txt
        
        # Start main.py in background
        echo "â–¶ï¸ Starting main.py..."
        nohup python3 main.py > app.log 2>&1 &
        
        # Wait and verify process started
        sleep 5
        if pgrep -f "python.*main.py" > /dev/null; then
          echo "âœ… main.py started successfully!"
          echo "ğŸ“‹ Process ID: \$(pgrep -f 'python.*main.py')"
        else
          echo "âŒ Failed to start main.py. Check app.log for errors."
          tail -20 app.log
          exit 1
        fi
        
        echo "ğŸ‰ Production deployment completed successfully!"
        EOFPROD
        
        # Copy and execute deployment script
        scp -i private_key.pem -o StrictHostKeyChecking=no \
          deploy-prod.sh \
          ${{ secrets.EC2_PROD_USER }}@${{ secrets.EC2_PROD_HOST }}:/home/${{ secrets.EC2_PROD_USER }}/
        
        # Execute deployment
        ssh -i private_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_PROD_USER }}@${{ secrets.EC2_PROD_HOST }} \
          'chmod +x deploy-prod.sh && ./deploy-prod.sh'

    - name: Verify Production Deployment
      if: env.SHOULD_DEPLOY == 'true'
      run: |
        # Wait for service to fully start
        sleep 5
        
        # Check if the service is responding
        echo "ğŸ” Checking if main.py is running..."
        ssh -i private_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_PROD_USER }}@${{ secrets.EC2_PROD_HOST }} \
          'pgrep -f "python.*main.py" && echo "âœ… main.py is running" || echo "âŒ main.py is not running"'

    - name: Notify Production Deployment
      if: env.SHOULD_DEPLOY == 'true'
      run: |
        echo "ğŸ‰ Production deployment completed successfully!"
        echo "ğŸŒ Live at: https://be-pr.ornakala.com"
        echo "ğŸ“Š Monitor the application and check logs if needed"
        echo "ğŸ“‹ main.py is running directly on the server in ~/ornakala-backend/"
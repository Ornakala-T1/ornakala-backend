name: CI/CD Pipeline

on:
  # Run tests on all PRs to main
  pull_request:
    branches: [ main ]
  
  # Auto-deploy to dev when merged to main
  push:
    branches: [ main ]
  
  # Manual deployment to production
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy to Production (only after testing on dev)'
        required: true
        default: 'prod'
        type: choice
        options:
        - prod

jobs:
  # Run tests and SonarQube check on all PRs and main branch pushes
  test-and-quality:
    runs-on: ubuntu-latest
    name: "Tests & Quality Gate"
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Run tests
      run: |
        python -m pytest tests/ -v --cov=. --cov-report=xml

    - name: SonarQube Scan
      uses: sonarqube-quality-gate-action@master
      with:
        scanMetadataReportFile: target/sonar/report-task.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Auto-deploy to dev when code is merged to main
  deploy-dev:
    needs: test-and-quality
    runs-on: ubuntu-latest
    name: "ğŸš€ Deploy to Development"
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: 
      name: development
      url: https://be-de.ornakala.com
    
    steps:
    - uses: actions/checkout@v4

    - name: Deploy to Development Server
      run: |
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > private_key.pem
        chmod 600 private_key.pem
        
        # Create deployment script inline
        cat > deploy-dev.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ Starting deployment to development server..."
        
        # Navigate to application directory
        cd ~/ornakala-backend || {
          echo "Creating ornakala-backend directory..."
          mkdir -p ~/ornakala-backend
          cd ~/ornakala-backend
        }
        
        # Stop existing main.py process if running
        echo "ğŸ›‘ Stopping existing main.py process..."
        pkill -f "python.*main.py" || echo "No existing main.py process found"
        sleep 2
        
        # Pull latest code
        echo "ï¿½ Pulling latest code..."
        if [ -d ".git" ]; then
          git fetch origin
          git reset --hard origin/main
        else
          git clone https://github.com/Ornakala-T1/ornakala-backend.git .
        fi
        
        # Install/update dependencies
        echo "ğŸ“¦ Installing dependencies..."
        python3 -m pip install --user -r requirements.txt
        
        # Start main.py in background
        echo "â–¶ï¸ Starting main.py..."
        nohup python3 main.py > app.log 2>&1 &
        
        # Wait a bit and check if process started successfully
        sleep 3
        if pgrep -f "python.*main.py" > /dev/null; then
          echo "âœ… main.py started successfully!"
          echo "ğŸ“‹ Process ID: $(pgrep -f 'python.*main.py')"
        else
          echo "âŒ Failed to start main.py. Check app.log for errors."
          tail -20 app.log
          exit 1
        fi
        
        echo "ğŸ‰ Deployment completed successfully!"
        EOF
        
        # Copy and execute deployment script
        scp -i private_key.pem -o StrictHostKeyChecking=no \
          deploy-dev.sh \
          ${{ secrets.EC2_DEV_USER }}@${{ secrets.EC2_DEV_HOST }}:/home/${{ secrets.EC2_DEV_USER }}/
        
        # Execute deployment
        ssh -i private_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_DEV_USER }}@${{ secrets.EC2_DEV_HOST }} \
          'chmod +x deploy-dev.sh && ./deploy-dev.sh'

    - name: Verify Deployment
      run: |
        # Wait a bit for the service to fully start
        sleep 5
        
        # Check if the service is responding (assuming it runs on port 8000)
        echo "ğŸ” Checking if main.py is running..."
        ssh -i private_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_DEV_USER }}@${{ secrets.EC2_DEV_HOST }} \
          'pgrep -f "python.*main.py" && echo "âœ… main.py is running" || echo "âŒ main.py is not running"'

    - name: Notify Development Deployment
      run: |
        echo "âœ… Development deployment completed!"
        echo "ğŸ”— Test your changes at: https://be-de.ornakala.com"
        echo "ğŸ“ Once testing is complete, you can manually deploy to production"
        echo "ğŸ“‹ main.py is running directly on the server in ~/ornakala-backend/"

  # Manual deployment to production (only after dev testing)
  deploy-prod:
    needs: test-and-quality
    runs-on: ubuntu-latest
    name: "ğŸš€ Deploy to Production"
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment: 
      name: production
      url: https://be-pr.ornakala.com
    
    steps:
    - uses: actions/checkout@v4

    - name: Check if commit was deployed to dev
      run: |
        echo "âš ï¸  IMPORTANT: Ensure this commit (${{ github.sha }}) has been tested on development!"
        echo "ğŸ”— Development URL: https://be-de.ornakala.com"
        echo "ğŸ¯ Production deployment will use commit: ${{ github.sha }}"

    - name: Deploy to Production Server
      run: |
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > private_key.pem
        chmod 600 private_key.pem
        
        # Create production deployment script
        cat > deploy-prod.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ Starting production deployment..."
        
        # Navigate to application directory
        cd ~/ornakala-backend || {
          echo "Creating ornakala-backend directory..."
          mkdir -p ~/ornakala-backend
          cd ~/ornakala-backend
        }
        
        # Stop existing main.py process if running
        echo "ğŸ›‘ Stopping existing main.py process..."
        pkill -f "python.*main.py" || echo "No existing main.py process found"
        sleep 3
        
        # Pull latest code
        echo "ğŸ›‘ Pulling latest code..."
        if [ -d ".git" ]; then
          git fetch origin
          git reset --hard origin/main
        else
          git clone https://github.com/Ornakala-T1/ornakala-backend.git .
        fi
        
        # Install/update dependencies
        echo "ğŸ“¦ Installing dependencies..."
        python3 -m pip install --user -r requirements.txt
        
        # Start main.py in background
        echo "â–¶ï¸ Starting main.py..."
        nohup python3 main.py > app.log 2>&1 &
        
        # Wait and verify process started
        sleep 5
        if pgrep -f "python.*main.py" > /dev/null; then
          echo "âœ… main.py started successfully!"
          echo "ğŸ“‹ Process ID: $(pgrep -f 'python.*main.py')"
        else
          echo "âŒ Failed to start main.py. Check app.log for errors."
          tail -20 app.log
          exit 1
        fi
        
        echo "ğŸ‰ Production deployment completed successfully!"
        EOF
        
        # Copy and execute deployment script
        scp -i private_key.pem -o StrictHostKeyChecking=no \
          deploy-prod.sh \
          ${{ secrets.EC2_PROD_USER }}@${{ secrets.EC2_PROD_HOST }}:/home/${{ secrets.EC2_PROD_USER }}/
        
        # Execute deployment
        ssh -i private_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_PROD_USER }}@${{ secrets.EC2_PROD_HOST }} \
          'chmod +x deploy-prod.sh && ./deploy-prod.sh'

    - name: Verify Production Deployment
      run: |
        # Wait for service to fully start
        sleep 5
        
        # Check if the service is responding
        echo "ğŸ” Checking if main.py is running..."
        ssh -i private_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_PROD_USER }}@${{ secrets.EC2_PROD_HOST }} \
          'pgrep -f "python.*main.py" && echo "âœ… main.py is running" || echo "âŒ main.py is not running"'

    - name: Notify Production Deployment
      run: |
        echo "ğŸ‰ Production deployment completed successfully!"
        echo "ğŸŒ Live at: https://be-pr.ornakala.com"
        echo "ğŸ“Š Monitor the application and check logs if needed"
        echo "ğŸ“‹ main.py is running directly on the server in ~/ornakala-backend/"
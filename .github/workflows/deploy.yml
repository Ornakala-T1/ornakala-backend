name: CI/CD Pipeline

on:
  # Run tests on all PRs to main
  pull_request:
    branches: [ main ]
  
  # Auto-deploy to dev when merged to main
  push:
    branches: [ main ]
  
  # Manual deployment to production
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod

jobs:
  # Stage 1: Run tests and SonarQube check on all PRs and main branch pushes
  test-and-quality:
    runs-on: ubuntu-latest
    name: "üß™ Tests & Quality Gate"
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Run tests
      run: |
        python -m pytest tests/ -v --cov=. --cov-report=xml

    - name: SonarQube Scan
      uses: SonarSource/sonarqube-scan-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      continue-on-error: true  # Don't fail if SonarQube is not configured

  # Stage 2: Always show deployment stage (but conditionally execute)
  check-deployment-trigger:
    needs: test-and-quality
    runs-on: ubuntu-latest
    name: "üîç Check Deployment Trigger"
    steps:
    - name: Analyze deployment conditions
      run: |
        echo "Event: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "Branch: ${{ github.ref_name }}"
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "‚úÖ Will deploy to development (auto-deploy on main)"
        elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "‚úÖ Will deploy to ${{ github.event.inputs.environment }} (manual trigger)"
        else
          echo "‚ÑπÔ∏è No deployment triggered for this event"
        fi

  # Stage 3: Deploy to Development (auto on main push, manual trigger available)
  deploy-dev:
    needs: [test-and-quality, check-deployment-trigger]
    runs-on: ubuntu-latest
    name: "üöÄ Deploy to Development"
<<<<<<< HEAD
    if: always() && (needs.test-and-quality.result == 'success') && ((github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev'))
=======
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
>>>>>>> 29890804ce1d5e16ed3f58218d73289276d2b409
    environment: 
      name: development
      url: https://be-de.ornakala.com
    
    steps:
    - uses: actions/checkout@v4

    - name: Deploy to Development Server
      run: |
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > private_key.pem
        chmod 600 private_key.pem
        
        # Create deployment script inline
        cat > deploy-dev.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "üöÄ Starting deployment to development server..."
        
        # Navigate to application directory
        cd ~/ornakala-backend || {
          echo "Creating ornakala-backend directory..."
          mkdir -p ~/ornakala-backend
          cd ~/ornakala-backend
        }
        
        # Stop existing main.py process if running
        echo "üõë Stopping existing main.py process..."
        pkill -f "python.*main.py" || echo "No existing main.py process found"
        sleep 2
        
        # Pull latest code
        echo "üì• Pulling latest code..."
        if [ -d ".git" ]; then
          git fetch origin
          git reset --hard origin/main
        else
          git clone https://github.com/Ornakala-T1/ornakala-backend.git .
        fi
        
        # Install/update dependencies
        echo "üì¶ Installing dependencies..."
        python3 -m pip install --user -r requirements.txt
        
        # Start main.py in background
        echo "‚ñ∂Ô∏è Starting main.py..."
        nohup python3 main.py > app.log 2>&1 &
        
        # Wait a bit and check if process started successfully
        sleep 3
        if pgrep -f "python.*main.py" > /dev/null; then
          echo "‚úÖ main.py started successfully!"
          echo "üìã Process ID: $(pgrep -f 'python.*main.py')"
        else
          echo "‚ùå Failed to start main.py. Check app.log for errors."
          tail -20 app.log
          exit 1
        fi
        
        echo "üéâ Deployment completed successfully!"
        EOF
        
        # Copy and execute deployment script
        scp -i private_key.pem -o StrictHostKeyChecking=no \
          deploy-dev.sh \
          ${{ secrets.EC2_DEV_USER }}@${{ secrets.EC2_DEV_HOST }}:/home/${{ secrets.EC2_DEV_USER }}/
        
        # Execute deployment
        ssh -i private_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_DEV_USER }}@${{ secrets.EC2_DEV_HOST }} \
          'chmod +x deploy-dev.sh && ./deploy-dev.sh'

    - name: Verify Deployment
      run: |
        # Wait a bit for the service to fully start
        sleep 5
        
        # Check if the service is responding (assuming it runs on port 8000)
        echo "üîç Checking if main.py is running..."
        ssh -i private_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_DEV_USER }}@${{ secrets.EC2_DEV_HOST }} \
          'pgrep -f "python.*main.py" && echo "‚úÖ main.py is running" || echo "‚ùå main.py is not running"'

    - name: Notify Development Deployment
      run: |
        echo "‚úÖ Development deployment completed!"
        echo "üîó Test your changes at: https://be-de.ornakala.com"
        echo "üìù Once testing is complete, you can manually deploy to production"
        echo "üìã main.py is running directly on the server in ~/ornakala-backend/"

  # Stage 4: Deploy to Production (manual trigger only)
  deploy-prod:
    needs: [test-and-quality, check-deployment-trigger]
    runs-on: ubuntu-latest
    name: "üéØ Deploy to Production"
    if: always() && (needs.test-and-quality.result == 'success') && (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    environment: 
      name: production
      url: https://be-pr.ornakala.com
    
    steps:
    - uses: actions/checkout@v4

    - name: Check if commit was deployed to dev
      run: |
        echo "‚ö†Ô∏è  IMPORTANT: Ensure this commit (${{ github.sha }}) has been tested on development!"
        echo "üîó Development URL: https://be-de.ornakala.com"
        echo "üéØ Production deployment will use commit: ${{ github.sha }}"

    - name: Deploy to Production Server
      run: |
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > private_key.pem
        chmod 600 private_key.pem
        
        # Create production deployment script
        cat > deploy-prod.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "üöÄ Starting production deployment..."
        
        # Navigate to application directory
        cd ~/ornakala-backend || {
          echo "Creating ornakala-backend directory..."
          mkdir -p ~/ornakala-backend
          cd ~/ornakala-backend
        }
        
        # Stop existing main.py process if running
        echo "üõë Stopping existing main.py process..."
        pkill -f "python.*main.py" || echo "No existing main.py process found"
        sleep 3
        
        # Pull latest code
        echo "üì• Pulling latest code..."
        if [ -d ".git" ]; then
          git fetch origin
          git reset --hard origin/main
        else
          git clone https://github.com/Ornakala-T1/ornakala-backend.git .
        fi
        
        # Install/update dependencies
        echo "üì¶ Installing dependencies..."
        python3 -m pip install --user -r requirements.txt
        
        # Start main.py in background
        echo "‚ñ∂Ô∏è Starting main.py..."
        nohup python3 main.py > app.log 2>&1 &
        
        # Wait and verify process started
        sleep 5
        if pgrep -f "python.*main.py" > /dev/null; then
          echo "‚úÖ main.py started successfully!"
          echo "üìã Process ID: $(pgrep -f 'python.*main.py')"
        else
          echo "‚ùå Failed to start main.py. Check app.log for errors."
          tail -20 app.log
          exit 1
        fi
        
        echo "üéâ Production deployment completed successfully!"
        EOF
        
        # Copy and execute deployment script
        scp -i private_key.pem -o StrictHostKeyChecking=no \
          deploy-prod.sh \
          ${{ secrets.EC2_PROD_USER }}@${{ secrets.EC2_PROD_HOST }}:/home/${{ secrets.EC2_PROD_USER }}/
        
        # Execute deployment
        ssh -i private_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_PROD_USER }}@${{ secrets.EC2_PROD_HOST }} \
          'chmod +x deploy-prod.sh && ./deploy-prod.sh'

    - name: Verify Production Deployment
      run: |
        # Wait for service to fully start
        sleep 5
        
        # Check if the service is responding
        echo "üîç Checking if main.py is running..."
        ssh -i private_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_PROD_USER }}@${{ secrets.EC2_PROD_HOST }} \
          'pgrep -f "python.*main.py" && echo "‚úÖ main.py is running" || echo "‚ùå main.py is not running"'

    - name: Notify Production Deployment
      run: |
        echo "üéâ Production deployment completed successfully!"
        echo "üåê Live at: https://be-pr.ornakala.com"
        echo "üìä Monitor the application and check logs if needed"
        echo "üìã main.py is running directly on the server in ~/ornakala-backend/"